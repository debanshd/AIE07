<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Paper Social Media Poster - Backend Connected</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 2rem;
        }

        .form-section {
            background: #f8fafc;
            padding: 2rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #1e293b;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .status-section {
            margin-top: 2rem;
        }

        .agent-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .agent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .agent-name {
            font-weight: 600;
            color: #1e293b;
        }

        .agent-status {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-processing {
            background: #fef3c7;
            color: #d97706;
        }

        .status-completed {
            background: #d1fae5;
            color: #059669;
        }

        .status-failed {
            background: #fee2e2;
            color: #dc2626;
        }

        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background: #e5e7eb;
            border-radius: 0.25rem;
            overflow: hidden;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: -20px;
            right: 0;
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: 500;
        }

        .result-section {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .result-content {
            white-space: pre-wrap;
            font-family: 'Georgia', serif;
            line-height: 1.6;
            color: #1e293b;
        }

        .hidden {
            display: none;
        }

        /* Removed .loading CSS animation */
        /* .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        } */

        /* Removed @keyframes spin animation */
        /* @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        } */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ ML Paper Social Media Poster</h1>
            <p>Connected to Backend API - Generate LinkedIn posts from ML papers</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2>Create New Post</h2>
                <form id="postForm">
                    <div class="form-group">
                        <label for="openaiApiKey">OpenAI API Key *</label>
                        <input type="password" id="openaiApiKey" class="form-control" 
                               placeholder="sk-..." required>
                        <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                            üîí Your API key is only used for this session and is not stored. 
                            <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #667eea;">Get your API key here</a>
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="tavilyApiKey">Tavily API Key (optional)</label>
                        <input type="password" id="tavilyApiKey" class="form-control" 
                               placeholder="tvly-...">
                        <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                            üîç Optional for enhanced web search capabilities. 
                            <a href="https://app.tavily.com/sign-in" target="_blank" style="color: #667eea;">Get your API key here</a>
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="linkedinClientId">LinkedIn Client ID (optional)</label>
                        <input type="text" id="linkedinClientId" class="form-control" 
                               placeholder="Your LinkedIn app client ID">
                        <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                            üîó Optional. If not provided, server's LinkedIn app will be used. 
                            <a href="https://www.linkedin.com/developers/apps" target="_blank" style="color: #667eea;">Create LinkedIn app here</a>
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="linkedinClientSecret">LinkedIn Client Secret (optional)</label>
                        <input type="password" id="linkedinClientSecret" class="form-control" 
                               placeholder="Your LinkedIn app client secret">
                        <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                            üîí Optional. Required only if Client ID is provided.
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="paperTitle">Paper Title *</label>
                        <input type="text" id="paperTitle" class="form-control" 
                               placeholder="e.g., Attention Is All You Need" required>
                    </div>

                    <div class="form-group">
                        <label for="paperUrl">Paper URL (optional)</label>
                        <input type="url" id="paperUrl" class="form-control" 
                               placeholder="https://arxiv.org/abs/...">
                    </div>

                    <div class="form-group">
                        <label for="customInstructions">Custom Instructions (optional)</label>
                        <textarea id="customInstructions" class="form-control" rows="3" 
                                  placeholder="Any specific instructions for the agents..."></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span id="submitText">Create Post</span>
                    </button>
                </form>
            </div>

            <div id="statusSection" class="status-section hidden">
                <h2>Agent Status</h2>
                <div id="agentCards"></div>
            </div>

            <div id="resultSection" class="result-section hidden">
                <h2>Generated Content</h2>
                <div id="resultContent" class="result-content"></div>
                <div style="margin-top: 1rem;">
                    <button id="publishBtn" class="btn btn-primary" onclick="publishToLinkedIn()" disabled>
                        <span id="publishText">üöÄ Publish to LinkedIn</span>
                        <span id="publishLoader" class="loading hidden"></span>
                    </button>
                    <div id="linkedinResult" class="linkedin-result hidden" style="margin-top: 15px; padding: 15px; background-color: #f0f8ff; border-radius: 8px; border-left: 4px solid #0066cc;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.2em;">‚úÖ</span>
                            <div>
                                <div style="font-weight: 600; color: #0066cc;">Successfully Published to LinkedIn!</div>
                                <div style="margin-top: 5px;">
                                    <a id="linkedinUrl" href="#" target="_blank" style="color: #0066cc; text-decoration: none; font-weight: 500;">
                                        üîó View on LinkedIn
                                    </a>
                                </div>
                                <div id="linkedinPostId" style="font-size: 0.875rem; color: #666; margin-top: 3px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let currentPostId = null;
        let statusInterval = null;

        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const openaiApiKey = document.getElementById('openaiApiKey').value;
            const tavilyApiKey = document.getElementById('tavilyApiKey').value;
            const linkedinClientId = document.getElementById('linkedinClientId').value;
            const linkedinClientSecret = document.getElementById('linkedinClientSecret').value;
            const paperTitle = document.getElementById('paperTitle').value;
            const paperUrl = document.getElementById('paperUrl').value;
            const customInstructions = document.getElementById('customInstructions').value;
            
            // Basic validation for OpenAI API key format
            if (!openaiApiKey || !openaiApiKey.startsWith('sk-')) {
                alert('Please provide a valid OpenAI API key that starts with "sk-"');
                return;
            }
            
            // Basic validation for Tavily API key format (if provided)
            if (tavilyApiKey && !tavilyApiKey.startsWith('tvly-')) {
                alert('Please provide a valid Tavily API key that starts with "tvly-" or leave it empty');
                return;
            }
            
            // Basic validation for LinkedIn credentials (both required if either is provided)
            if (linkedinClientId && !linkedinClientSecret) {
                alert('Please provide both LinkedIn Client ID and Client Secret, or leave both empty');
                return;
            }
            if (linkedinClientSecret && !linkedinClientId) {
                alert('Please provide both LinkedIn Client ID and Client Secret, or leave both empty');
                return;
            }
            
            // Update UI
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            
            submitBtn.disabled = true;
            submitText.textContent = 'Creating...';
            
            try {
                const response = await fetch(`${API_BASE}/posts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        paperTitle,
                        paperUrl: paperUrl || null,
                        targetPlatform: 'LinkedIn',
                        customInstructions: customInstructions || null,
                        openaiApiKey: openaiApiKey || null,
                        tavilyApiKey: tavilyApiKey || null,
                        linkedinClientId: linkedinClientId || null,
                        linkedinClientSecret: linkedinClientSecret || null
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create post');
                }

                const post = await response.json();
                currentPostId = post.id;
                
                // Show status section and hide previous results
                document.getElementById('statusSection').classList.remove('hidden');
                document.getElementById('resultSection').classList.add('hidden');
                document.getElementById('linkedinResult').classList.add('hidden');
                
                // Start polling for status
                startStatusPolling();
                
                // Don't reset button immediately - let polling handle it
                return;
                
            } catch (error) {
                console.error('Error creating post:', error);
                alert('Failed to create post. Please try again.');
                
                // Reset button state on error
                submitBtn.disabled = false;
                submitText.textContent = 'Create Post';
            }
        });

        async function startStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
            }
            
            console.log('Starting status polling for post:', currentPostId);
            
            statusInterval = setInterval(async () => {
                try {
                    await updateAgentStatus();
                    await updatePostStatus();
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 1000); // Reduced to 1 second for more real-time updates
            
            // Initial update
            await updateAgentStatus();
            await updatePostStatus();
        }

        async function updateAgentStatus() {
            if (!currentPostId) return;
            
            try {
                const response = await fetch(`${API_BASE}/posts/${currentPostId}/agents`);
                if (!response.ok) return;
                
                const agents = await response.json();
                const agentCards = document.getElementById('agentCards');
                
                agentCards.innerHTML = agents.map(agent => `
                    <div class="agent-card">
                        <div class="agent-header">
                            <span class="agent-name">${agent.name}</span>
                            <span class="agent-status status-${agent.status}">${agent.status}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${agent.progress}%"></div>
                            <span class="progress-text">${agent.progress}%</span>
                        </div>
                        <p style="color: #6b7280; font-size: 0.875rem;">${agent.description}</p>
                        ${agent.result ? `<p style="color: ${agent.status === 'completed' ? '#059669' : '#0066cc'}; font-size: 0.875rem; margin-top: 0.5rem; font-weight: 500;">
                            ${agent.status === 'completed' ? '‚úÖ' : 'üîÑ'} ${agent.result}
                        </p>` : ''}
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error updating agent status:', error);
            }
        }

        async function updatePostStatus() {
            if (!currentPostId) return;
            
            try {
                const response = await fetch(`${API_BASE}/posts/${currentPostId}`);
                if (!response.ok) {
                    console.error('Failed to fetch post status:', response.status);
                    return;
                }
                
                const post = await response.json();
                console.log('Post status:', post.status, 'Content length:', post.content ? post.content.length : 0);
                
                if (post.status === 'completed' && post.content) {
                    // Show result
                    document.getElementById('resultContent').textContent = post.content;
                    document.getElementById('resultSection').classList.remove('hidden');
                    
                    // Enable publish button
                    document.getElementById('publishBtn').disabled = false;
                    
                    // Reset Create Post button state
                    resetCreatePostButton();
                    
                    // Stop polling
                    stopStatusPolling();
                    
                } else if (post.status === 'failed') {
                    alert('Post generation failed. Please try again.');
                    
                    // Reset Create Post button state
                    resetCreatePostButton();
                    
                    // Stop polling
                    stopStatusPolling();
                }
                
            } catch (error) {
                console.error('Error fetching post status:', error);
                
                // Reset button state on error
                resetCreatePostButton();
                stopStatusPolling();
            }
        }
        
        function resetCreatePostButton() {
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            
            if (submitBtn) {
                submitBtn.disabled = false;
                submitText.textContent = 'Create Post';
            }
        }
        
        function stopStatusPolling() {
            if (statusInterval) {
                clearInterval(statusInterval);
                statusInterval = null;
                console.log('Status polling stopped');
            }
        }

        async function publishToLinkedIn() {
            if (!currentPostId) return;
            
            const publishBtn = document.getElementById('publishBtn');
            const publishText = document.getElementById('publishText');
            const publishLoader = document.getElementById('publishLoader');
            
            // Hide previous LinkedIn result
            document.getElementById('linkedinResult').classList.add('hidden');
            
            publishBtn.disabled = true;
            publishText.textContent = 'Authenticating...';
            publishLoader.classList.remove('hidden');
            
            try {
                // Get LinkedIn authentication URL
                const authResponse = await fetch(`${API_BASE}/posts/${currentPostId}/linkedin-auth`);
                if (!authResponse.ok) {
                    throw new Error('Failed to get authentication URL');
                }
                
                const authData = await authResponse.json();
                publishText.textContent = 'Opening LinkedIn...';
                
                // Open LinkedIn authentication in a popup window
                const popup = window.open(
                    authData.auth_url,
                    'linkedin-auth',
                    'width=600,height=600,scrollbars=yes,resizable=yes'
                );
                
                publishText.textContent = 'Waiting for authentication...';
                
                // Listen for messages from the popup
                const messageListener = (event) => {
                    console.log('Received message:', event.data, 'from origin:', event.origin);
                    
                    // Accept messages from localhost (development) or same origin
                    const allowedOrigins = [
                        window.location.origin,
                        'http://localhost:8000',
                        'http://127.0.0.1:8000',
                        'null' // for file:// protocol
                    ];
                    
                    if (!allowedOrigins.includes(event.origin)) {
                        console.log('Ignoring message from different origin:', event.origin);
                        return;
                    }
                    
                    if (event.data && event.data.type === 'LINKEDIN_AUTH_SUCCESS') {
                        console.log('Authentication successful, code:', event.data.code);
                        window.removeEventListener('message', messageListener);
                        clearInterval(checkClosed);
                        if (!popup.closed) popup.close();
                        
                        // Clean up localStorage
                        localStorage.removeItem('linkedin_auth_code');
                        localStorage.removeItem('linkedin_auth_timestamp');
                        
                        handleLinkedInCallback(event.data.code);
                    } else if (event.data && event.data.type === 'LINKEDIN_AUTH_ERROR') {
                        console.log('Authentication error:', event.data.error);
                        window.removeEventListener('message', messageListener);
                        clearInterval(checkClosed);
                        if (!popup.closed) popup.close();
                        
                        // Clean up localStorage
                        localStorage.removeItem('linkedin_auth_code');
                        localStorage.removeItem('linkedin_auth_timestamp');
                        
                        publishBtn.disabled = false;
                        publishText.textContent = 'üöÄ Publish to LinkedIn';
                        publishLoader.classList.add('hidden');
                        alert(`Authentication failed: ${event.data.error}`);
                    }
                };
                
                window.addEventListener('message', messageListener);
                
                // Fallback: Listen for the popup to close
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        window.removeEventListener('message', messageListener);
                        
                        console.log('Popup closed, checking localStorage for auth code');
                        
                        // Wait a bit for localStorage to be updated
                        setTimeout(() => {
                            // Check if we got the auth code as fallback
                            const authCode = localStorage.getItem('linkedin_auth_code');
                            const authTimestamp = localStorage.getItem('linkedin_auth_timestamp');
                            
                            if (authCode && authTimestamp) {
                                const timestamp = parseInt(authTimestamp);
                                const now = Date.now();
                                
                                // Only use the code if it's fresh (within last 30 seconds)
                                if (now - timestamp < 30000) {
                                    console.log('Found fresh auth code in localStorage:', authCode);
                                    localStorage.removeItem('linkedin_auth_code');
                                    localStorage.removeItem('linkedin_auth_timestamp');
                                    handleLinkedInCallback(authCode);
                                    return;
                                } else {
                                    console.log('Auth code in localStorage is stale, ignoring');
                                    localStorage.removeItem('linkedin_auth_code');
                                    localStorage.removeItem('linkedin_auth_timestamp');
                                }
                            }
                            
                            console.log('No valid auth code found, authentication failed');
                            publishBtn.disabled = false;
                            publishText.textContent = 'üöÄ Publish to LinkedIn';
                            publishLoader.classList.add('hidden');
                            alert('Authentication cancelled or failed');
                        }, 500);
                        
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error starting LinkedIn authentication:', error);
                alert(`Failed to start LinkedIn authentication: ${error.message}`);
                publishBtn.disabled = false;
                publishText.textContent = 'üöÄ Publish to LinkedIn';
                publishLoader.classList.add('hidden');
            }
        }
        
        async function handleLinkedInCallback(authCode) {
            const publishBtn = document.getElementById('publishBtn');
            const publishText = document.getElementById('publishText');
            const publishLoader = document.getElementById('publishLoader');
            
            publishText.textContent = 'Publishing to LinkedIn...';
            
            try {
                const response = await fetch(`${API_BASE}/posts/${currentPostId}/linkedin-callback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code: authCode })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    publishText.textContent = '‚úÖ Published to LinkedIn';
                    
                    // Display success message with LinkedIn URL
                    const linkedinUrl = result.linkedinUrl;
                    const linkedinPostId = result.linkedinPostId;
                    
                    if (linkedinUrl) {
                        // Show the LinkedIn result in the UI
                        const linkedinResult = document.getElementById('linkedinResult');
                        const linkedinUrlElement = document.getElementById('linkedinUrl');
                        const linkedinPostIdElement = document.getElementById('linkedinPostId');
                        
                        if (linkedinResult && linkedinUrlElement && linkedinPostIdElement) {
                            linkedinUrlElement.href = linkedinUrl;
                            linkedinPostIdElement.textContent = `Post ID: ${linkedinPostId}`;
                            linkedinResult.classList.remove('hidden');
                        }
                        
                        // Also show a brief success message
                        const message = `Post published successfully to LinkedIn!`;
                        alert(message);
                    } else {
                        alert('Post published successfully to LinkedIn!');
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to publish');
                }
                
            } catch (error) {
                console.error('Error publishing to LinkedIn:', error);
                alert(`Failed to publish to LinkedIn: ${error.message}`);
                publishBtn.disabled = false;
                publishText.textContent = 'üöÄ Publish to LinkedIn';
            } finally {
                publishLoader.classList.add('hidden');
            }
        }

        // Test API connection on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    const health = await response.json();
                    console.log('‚úÖ Connected to backend API:', health);
                } else {
                    console.error('‚ùå Backend API not responding');
                }
            } catch (error) {
                console.error('‚ùå Failed to connect to backend API:', error);
            }
        });
    </script>
</body>
</html> 